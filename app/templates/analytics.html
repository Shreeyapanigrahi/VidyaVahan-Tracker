{% extends "layout.html" %}

{% block title %}Speed & Distance Analytics{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h2"><i class="fas fa-chart-line me-2 text-primary"></i>Speed & Distance Analytics</h1>
            <a href="{{ url_for('vehicle.dashboard') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Dashboard
            </a>
        </div>
        <hr>
    </div>
</div>

{% if trips %}
<div class="row g-4 mb-5">
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white py-3">
                <h5 class="card-title mb-0"><i class="fas fa-ruler-horizontal me-2 text-success"></i>Distance Per Trip
                </h5>
            </div>
            <div class="card-body">
                <canvas id="distanceChart" style="min-height: 300px;"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-header bg-white py-3">
                <h5 class="card-title mb-0"><i class="fas fa-tachometer-alt me-2 text-info"></i>Speed Per Trip</h5>
            </div>
            <div class="card-body">
                <canvas id="speedChart" style="min-height: 300px;"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3">
                <h5 class="card-title mb-0">Detailed Trip Log</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">Trip</th>
                                <th>Distance (km)</th>
                                <th>Avg Speed (km/h)</th>
                                <th>Battery Used</th>
                                <th>Score</th>
                                <th class="text-end pe-4">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trip in trips %}
                            <tr>
                                <td class="ps-4 fw-bold">#{{ loop.index }}</td>
                                <td>{{ trip.total_distance_km }}</td>
                                <td>{{ trip.average_speed_kmph }}</td>
                                <td>{{ trip.battery_consumed_percent }}%</td>
                                <td>
                                    <span
                                        class="badge {% if trip.driving_score >= 80 %}bg-success{% elif trip.driving_score >= 60 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                                        {{ trip.driving_score }}
                                    </span>
                                </td>
                                <td class="text-end pe-4">
                                    <span class="badge bg-secondary rounded-pill">Completed</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="row">
    <div class="col-12 text-center py-5">
        <div class="display-1 text-muted mb-4"><i class="fas fa-folder-open"></i></div>
        <h3>No completed trips found.</h3>
        <p class="text-muted">Start a trip from your dashboard to record some data!</p>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
{% if trips %}
<script>
    (function () {
        const labels = {{ labels | tojson | safe
    }};
    const distances = {{ distances | tojson | safe }};
    const speeds = {{ speeds | tojson | safe }};

    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: { display: false }
        },
        scales: {
            y: { beginAtZero: true }
        }
    };

    // Distance Chart
    const distCtx = document.getElementById("distanceChart");
    if (distCtx) {
        new Chart(distCtx, {
            type: "bar",
            data: {
                labels: labels,
                datasets: [{
                    label: "Distance (km)",
                    data: distances,
                    backgroundColor: 'rgba(25, 135, 84, 0.7)',
                    borderColor: 'rgb(25, 135, 84)',
                    borderWidth: 1
                }]
            },
            options: chartOptions
        });
    }

    // Speed Chart
    const speedCtx = document.getElementById("speedChart");
    if (speedCtx) {
        new Chart(speedCtx, {
            type: "line",
            data: {
                labels: labels,
                datasets: [{
                    label: "Speed (km/h)",
                    data: speeds,
                    backgroundColor: 'rgba(13, 202, 240, 0.2)',
                    borderColor: 'rgb(13, 202, 240)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: chartOptions
        });
    }
    }) ();
</script>
{% endif %}
{% endblock %}